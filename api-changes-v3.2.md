# Изменения API и Сервера v3.2: Закрепление и Пересылка Сообщений

Этот документ описывает изменения в API и серверной логике, реализованные для поддержки функционала закрепления и пересылки сообщений, а также связанные с этим обновления.

## 1. Закрепление Сообщений (Pinning)

### 1.1. API: Закрепить / Открепить Сообщение

*   **Метод:** `POST`
*   **Путь:** `/conversations/pin/toggle`
    *   *Изменение:* Параметры `conversationId` и `messageId` теперь передаются в теле запроса, а не в URL.
*   **Заголовки:** `Authorization: Bearer <your_token>`, `Content-Type: application/json`
*   **Тело Запроса (JSON):**
    ```json
    {
      "conversationId": "uuid-чата",
      "messageId": "uuid-сообщения-для-закрепления"
    }
    ```
*   **Ответ (Успех 200 OK):**
    ```json
    {
      "success": true,
      "pinned_message_ids": ["uuid-закрепл-сообщ-1", "...", "uuid-нового-закрепл-сообщ"] // Актуальный список ID закрепленных сообщений в чате
    }
    ```
*   **Ответ (Ошибка):** `400` (невалидное тело запроса), `401`, `403` (не участник), `404` (чат или сообщение не найдены), `500`.
*   **Серверная логика:**
    *   Реализован контроллер `togglePinMessage` в `src/controllers/conversationController.ts`.
    *   Проверяет, является ли пользователь участником чата.
    *   Проверяет, существует ли сообщение в данном чате.
    *   Добавляет или удаляет запись в таблице `pinned_messages`.
    *   Возвращает актуальный список ID закрепленных сообщений.

### 1.2. API: Получение Списка Чатов

*   **Метод:** `GET`
*   **Путь:** `/conversations/`
*   **Изменение в ответе:** Каждый объект чата в массиве теперь содержит поле `pinned_message_ids`:
    ```json
      {
        // ... другие поля чата ...
        "pinned_message_ids": ["uuid-закрепл-сообщ-1", "..."] // Массив ID закрепленных сообщений (может быть пустым)
        // ... остальные поля чата ...
      }
    ```
*   **Серверная логика:**
    *   Обновлен контроллер `fetchAllConversationsByUserId` в `src/controllers/conversationController.ts` для добавления поля `pinned_message_ids` (полученного из таблицы `pinned_messages`).

### 1.3. WebSocket: Обновление Статуса Закрепления

*   **Событие:** `conversationUpdated` (существующее событие)
*   **Направление:** Сервер -> Клиент (в комнату чата `conversationId`)
*   **Payload:** Когда список закрепленных сообщений в чате изменяется (после вызова `POST /conversations/pin/toggle`), сервер отправляет это событие с обновленным списком:
    ```json
    {
      "id": "uuid-чата",
      "pinned_message_ids": ["uuid-закрепл-сообщ-1", "..."]
    }
    ```
*   **Серверная логика:**
    *   Контроллер `togglePinMessage` использует `socketService.emitToRoom` для отправки события `conversationUpdated`.

## 2. Пересылка Сообщений (Forwarding)

### 2.1. API: Переслать Сообщения

*   **Метод:** `POST`
*   **Путь:** `/messages/forward`
*   **Заголовки:** `Authorization: Bearer <your_token>`, `Content-Type: application/json`
*   **Тело Запроса (JSON):**
    ```json
    {
      "message_ids": ["uuid-исходн-сообщ-1", "uuid-исходн-сообщ-2", ...],
      "target_conversation_ids": ["uuid-целев-чата-1", "uuid-целев-чата-2", ...]
    }
    ```
*   **Ответ (Успех 200 OK):**
    ```json
    {
      "success": true,
      "forwarded_messages": {
        "uuid-целев-чата-1": ["uuid-нов-сообщ-1a", "uuid-нов-сообщ-2a"],
        "uuid-целев-чата-2": ["uuid-нов-сообщ-1b", "uuid-нов-сообщ-2b"]
        // Ключ - ID целевого чата, значение - массив ID *новых* созданных сообщений
      }
    }
    ```
*   **Ответ (Ошибка):** `400` (невалидные ID), `401`, `403` (нет доступа к целевому чату), `404` (исходное сообщение не найдено - пропускается), `500`.
*   **Серверная логика:**
    *   Реализован контроллер `forwardMessages` в `src/controllers/messagesController.ts`.
    *   Проверяет доступ пользователя ко всем целевым чатам.
    *   Для каждого исходного `message_id`:
        *   Получает данные исходного сообщения (контент, отправитель, файлы).
        *   Пропускает ID, если сообщение не найдено.
        *   Для каждого `target_conversation_id`:
            *   **Дублирует файлы:** Создает *новые* записи в таблице `files` для каждого файла исходного сообщения (ссылаясь на тот же `file_path`).
            *   **Создает новое сообщение:** Вставляет новую запись в `messages` с:
                *   `sender_id` = ID пользователя, выполняющего пересылку.
                *   `sender_username` = Имя пользователя, выполняющего пересылку.
                *   `content` = Контент исходного сообщения.
                *   `is_forwarded` = `TRUE`.
                *   `forwarded_from_user_id` = ID исходного отправителя.
                *   `forwarded_from_username` = Имя исходного отправителя.
                *   `original_message_id` = ID исходного сообщения.
            *   **Привязывает новые файлы:** Обновляет `message_id` в новых записях `files`, связывая их с *новым* пересланным сообщением.
            *   **Отмечает прочитанным:** Добавляет запись в `message_reads` для пользователя, выполнившего пересылку, и нового сообщения.
            *   Сохраняет ID нового сообщения для ответа API.

### 2.2. API: Получение Списка Сообщений

*   **Метод:** `GET`
*   **Путь:** `/messages/:conversation_id`
*   **Изменение в ответе:** Каждый объект сообщения в массиве теперь содержит поля пересылки:
    ```json
    [
      {
        // ... стандартные поля сообщения ...
        "is_forwarded": false, // или true
        "forwarded_from_user_id": null, // или "uuid-исходного-отправителя"
        "forwarded_from_username": null, // или "Имя-исходного-отправителя"
        "original_message_id": null, // или "uuid-исходного-сообщения"
        // ... остальные поля ...
      }
    ]
    ```
*   **Серверная логика:**
    *   Обновлен контроллер `fetchAllMessagesByConversationId` в `src/controllers/messagesController.ts` для выборки и возврата новых полей (`is_forwarded` и т.д.) из таблицы `messages`.

### 2.3. WebSocket: Получение Нового Сообщения

*   **Событие:** `newMessage` (существующее событие)
*   **Направление:** Сервер -> Клиент (в комнату чата `conversationId`)
*   **Изменение в Payload:** Объект нового сообщения (как при обычной отправке, так и при пересылке) теперь всегда включает поля пересылки:
    ```json
    {
      // ... стандартные поля сообщения (id, conversation_id, content и т.д.) ...
      "sender_id": "uuid-отправителя", // При пересылке - ID того, кто переслал
      "sender_username": "Имя-отправителя", // При пересылке - имя того, кто переслал
      "is_forwarded": true, // или false для обычных сообщений
      "forwarded_from_user_id": "uuid-исходного-отправителя", // или null
      "forwarded_from_username": "Имя-исходного-отправителя", // или null
      "original_message_id": "uuid-исходного-сообщения", // или null
      // ... остальные поля (files, read_by_users и т.д.) ...
    }
    ```
*   **Серверная логика:**
    *   Контроллер `forwardMessages` после создания каждого нового пересланного сообщения получает его полные данные (включая поля пересылки) и отправляет событие `newMessage` в соответствующую комнату чата через `socketService.emitToRoom`.
    *   Функция `saveMessage` (используемая при обычной отправке через WebSocket) также была обновлена для возврата полного объекта сообщения, включая поля пересылки (установленные в `false`/`null`), который затем передается в событие `newMessage`.

## 3. Прочие Изменения

*   **Обработка Нескольких Файлов:**
    *   Функция `saveMessage` (используемая `src/index.ts`) теперь принимает массив `fileIds` вместо одного `fileId`.
    *   Обработчик `sendMessage` в `src/index.ts` обновлен для передачи массива `fileIds` (получаемого от клиента) в `saveMessage`.
*   **Контроллеры Сообщений:**
    *   Функции `saveMessage`, `editMessage`, `forwardMessages` теперь используют транзакции базы данных для обеспечения целостности данных.
    *   Добавлена вспомогательная функция `fetchFullMessageDetailsById` для унифицированного получения полных данных сообщения (включая файлы, статусы прочтения, информацию об ответе и пересылке).
*   **База Данных:**
    *   Добавлены столбцы `is_forwarded`, `forwarded_from_user_id`, `forwarded_from_username`, `original_message_id` в таблицу `messages`.
    *   Добавлена таблица `pinned_messages` со столбцами `conversation_id`, `message_id`, `pinned_by_user_id`, `pinned_at` и первичным ключом (`conversation_id`, `message_id`).
    *   (Рекомендовано) Добавлены соответствующие индексы для внешних ключей и для ускорения запросов. 