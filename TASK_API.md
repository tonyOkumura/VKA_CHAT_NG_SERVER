# API Документация для Задач (Tasks)

Базовый путь: `/api/tasks` (Предполагается, что роуты задач монтируются под этим префиксом)

**Аутентификация:** Все эндпоинты требуют валидный JWT токен в заголовке `Authorization: Bearer <token>`.

---

## Задачи

### 1. Создать новую задачу

*   **Метод:** `POST`
*   **Путь:** `/`
*   **Описание:** Создает новую задачу.
*   **Тело запроса (JSON):**
    ```json
    {
      "title": "Название задачи", // Обязательно
      "description": "Описание задачи", // Опционально
      "status": "open", // Опционально, default: "open"
      "priority": 3, // Опционально, default: 3
      "assignee_id": "uuid-пользователя-исполнителя", // Опционально
      "due_date": "2024-12-31T23:59:59.000Z" // Опционально
    }
    ```
*   **Успешный ответ (201 Created):**
    ```json
    // Полный объект созданной задачи из БД
    {
      "id": "uuid-задачи",
      "title": "Название задачи",
      "description": "Описание задачи",
      "status": "open",
      "priority": 3,
      "creator_id": "uuid-создателя",
      "assignee_id": "uuid-исполнителя",
      "due_date": "...",
      "created_at": "...",
      "updated_at": "..."
    }
    ```
*   **Ошибки:**
    *   `400 Bad Request`: Не указано название (`title`).
    *   `403 Forbidden`: Пользователь не аутентифицирован.
    *   `500 Internal Server Error`: Ошибка сервера.

### 2. Получить список задач

*   **Метод:** `GET`
*   **Путь:** `/`
*   **Описание:** Возвращает список задач, где текущий пользователь является создателем или исполнителем. Поддерживает фильтрацию по статусу и поиск по названию/описанию.
*   **Параметры запроса (Query Params):**
    *   `status` (string, опционально): Фильтровать задачи по статусу (например, `open`, `in_progress`, `closed`).
    *   `search` (string, опционально): Искать задачи, у которых название или описание содержит указанную строку (регистронезависимо).
*   **Успешный ответ (200 OK):**
    ```json
    [
      {
        "id": "uuid-задачи",
        "title": "Задача 1",
        "description": "...",
        "status": "open",
        "priority": 3,
        "creator_id": "uuid-создателя",
        "assignee_id": "uuid-исполнителя",
        "due_date": "...",
        "created_at": "...",
        "updated_at": "...",
        "creator_username": "имя_создателя",
        "assignee_username": "имя_исполнителя"
      },
      // ... другие задачи
    ]
    ```
*   **Ошибки:**
    *   `403 Forbidden`: Пользователь не аутентифицирован.
    *   `500 Internal Server Error`: Ошибка сервера.

### 3. Получить задачу по ID

*   **Метод:** `GET`
*   **Путь:** `/:id`
*   **Описание:** Возвращает детали конкретной задачи. Доступ разрешен только создателю или исполнителю задачи.
*   **Параметры пути:**
    *   `id` (uuid, обязательно): ID задачи.
*   **Успешный ответ (200 OK):**
    ```json
    {
      "id": "uuid-задачи",
      "title": "Название задачи",
      // ... все поля задачи ...
      "creator_username": "имя_создателя",
      "assignee_username": "имя_исполнителя"
    }
    ```
*   **Ошибки:**
    *   `400 Bad Request`: Неверный формат ID задачи.
    *   `403 Forbidden`: Пользователь не аутентифицирован или не имеет доступа к задаче.
    *   `404 Not Found`: Задача с указанным ID не найдена.
    *   `500 Internal Server Error`: Ошибка сервера.

### 4. Обновить задачу

*   **Метод:** `PUT`
*   **Путь:** `/:id`
*   **Описание:** Обновляет поля задачи. Обновлять может создатель или исполнитель. Логирует изменения.
*   **Параметры пути:**
    *   `id` (uuid, обязательно): ID задачи для обновления.
*   **Тело запроса (JSON):** Содержит только те поля, которые нужно обновить. Допустимые поля: `title`, `description`, `status`, `priority`, `assignee_id`, `due_date`.
    ```json
    {
      "status": "in_progress",
      "assignee_id": "новый-uuid-исполнителя"
      // ... другие поля по необходимости ...
    }
    ```
*   **Успешный ответ (200 OK):**
    ```json
    // Полный объект обновленной задачи
    {
      "id": "uuid-задачи",
      "title": "...",
      "status": "in_progress",
      // ... остальные поля ...
    }
    ```
*   **Ошибки:**
    *   `400 Bad Request`: Нет данных для обновления, переданы недопустимые поля, неверный формат ID задачи или ID исполнителя, неверный ID исполнителя (ошибка внешнего ключа).
    *   `403 Forbidden`: Пользователь не аутентифицирован или не имеет прав на обновление.
    *   `404 Not Found`: Задача не найдена.
    *   `500 Internal Server Error`: Ошибка сервера.

### 5. Удалить задачу

*   **Метод:** `DELETE`
*   **Путь:** `/:id`
*   **Описание:** Удаляет задачу. Удалять может только создатель задачи. Связанные комментарии и вложения удаляются каскадно (если настроено в БД).
*   **Параметры пути:**
    *   `id` (uuid, обязательно): ID задачи для удаления.
*   **Успешный ответ (204 No Content):** Пустое тело ответа.
*   **Ошибки:**
    *   `400 Bad Request`: Неверный формат ID задачи.
    *   `403 Forbidden`: Пользователь не аутентифицирован или не является создателем задачи.
    *   `404 Not Found`: Задача не найдена.
    *   `500 Internal Server Error`: Ошибка сервера.

---

## Комментарии к задачам

### 6. Добавить комментарий к задаче

*   **Метод:** `POST`
*   **Путь:** `/:id/comments`
*   **Описание:** Добавляет текстовый комментарий к задаче. Комментировать могут создатель и исполнитель задачи.
*   **Параметры пути:**
    *   `id` (uuid, обязательно): ID задачи.
*   **Тело запроса (JSON):**
    ```json
    {
      "comment": "Текст нового комментария." // Обязательно, не пустой
    }
    ```
*   **Успешный ответ (201 Created):**
    ```json
    {
      "id": "uuid-комментария",
      "task_id": "uuid-задачи",
      "commenter_id": "uuid-комментатора",
      "comment": "Текст нового комментария.",
      "created_at": "...",
      "commenter_username": "имя_комментатора"
    }
    ```
*   **Ошибки:**
    *   `400 Bad Request`: Не указан ID задачи, текст комментария пуст, неверный формат ID задачи.
    *   `403 Forbidden`: Пользователь не аутентифицирован или не имеет прав комментировать.
    *   `404 Not Found`: Задача не найдена.
    *   `500 Internal Server Error`: Ошибка сервера.

### 7. Получить комментарии задачи

*   **Метод:** `GET`
*   **Путь:** `/:id/comments`
*   **Описание:** Возвращает список комментариев для указанной задачи, отсортированных по дате создания. Доступ имеют создатель и исполнитель задачи.
*   **Параметры пути:**
    *   `id` (uuid, обязательно): ID задачи.
*   **Успешный ответ (200 OK):**
    ```json
    [
      {
        "id": "uuid-комментария",
        "task_id": "uuid-задачи",
        "commenter_id": "uuid-комментатора",
        "comment": "Текст комментария.",
        "created_at": "...",
        "commenter_username": "имя_комментатора"
      },
      // ... другие комментарии
    ]
    ```
*   **Ошибки:**
    *   `400 Bad Request`: Не указан ID задачи, неверный формат ID задачи.
    *   `403 Forbidden`: Пользователь не аутентифицирован или не имеет прав на просмотр.
    *   `404 Not Found`: Задача не найдена.
    *   `500 Internal Server Error`: Ошибка сервера.

---

## Вложения к задачам

### 8. Добавить вложение (файл) к задаче

*   **Метод:** `POST`
*   **Путь:** `/:id/attachments`
*   **Описание:** Загружает файл и прикрепляет его к задаче. Добавлять вложения могут создатель и исполнитель задачи. Использует `multipart/form-data`.
*   **Параметры пути:**
    *   `id` (uuid, обязательно): ID задачи.
*   **Тело запроса (multipart/form-data):**
    *   Поле `file`: Сам загружаемый файл.
*   **Успешный ответ (201 Created):**
    ```json
    {
      "id": "uuid-вложения",
      "task_id": "uuid-задачи",
      "file_name": "оригинальное_имя_файла.txt",
      "file_path": "относительный/путь/к/файлу_на_сервере.txt",
      "file_type": "text/plain",
      "file_size": 12345,
      "created_at": "..."
    }
    ```
*   **Ошибки:**
    *   `400 Bad Request`: Файл не загружен, не указан ID задачи, неверный формат ID задачи.
    *   `403 Forbidden`: Пользователь не аутентифицирован или не имеет прав на добавление вложений.
    *   `404 Not Found`: Задача не найдена (загруженный файл удаляется).
    *   `500 Internal Server Error`: Ошибка сервера (загруженный файл удаляется).

### 9. Получить список вложений задачи

*   **Метод:** `GET`
*   **Путь:** `/:id/attachments`
*   **Описание:** Возвращает список метаданных файлов, прикрепленных к задаче. Доступ имеют создатель и исполнитель задачи.
*   **Параметры пути:**
    *   `id` (uuid, обязательно): ID задачи.
*   **Успешный ответ (200 OK):**
    ```json
    [
      {
        "id": "uuid-вложения",
        "task_id": "uuid-задачи",
        "file_name": "файл1.pdf",
        "file_path": "путь/файл1.pdf",
        "file_type": "application/pdf",
        "file_size": 56789,
        "created_at": "..."
      },
      // ... другие вложения
    ]
    ```
*   **Ошибки:**
    *   `400 Bad Request`: Не указан ID задачи, неверный формат ID задачи.
    *   `403 Forbidden`: Пользователь не аутентифицирован или не имеет прав на просмотр.
    *   `404 Not Found`: Задача не найдена.
    *   `500 Internal Server Error`: Ошибка сервера.

---

## Логи изменений задач

### 10. Получить логи изменений задачи

*   **Метод:** `GET`
*   **Путь:** `/:id/logs`
*   **Описание:** Возвращает историю изменений полей задачи. Доступ имеют создатель и исполнитель задачи.
*   **Параметры пути:**
    *   `id` (uuid, обязательно): ID задачи.
*   **Успешный ответ (200 OK):**
    ```json
    [
      {
        "log_id": "uuid-лога",
        "task_id": "uuid-задачи",
        "action": "update_status",
        "old_value": "open",
        "new_value": "in_progress",
        "changed_by": "uuid-пользователя",
        "changed_at": "...",
        "changed_by_username": "имя_пользователя"
      },
      {
        "log_id": "uuid-лога",
        "task_id": "uuid-задачи",
        "action": "update_assignee_id",
        "old_value": "null",
        "new_value": "uuid-исполнителя",
        "changed_by": "uuid-пользователя",
        "changed_at": "...",
        "changed_by_username": "имя_пользователя"
      }
      // ... другие записи лога, отсортированные по убыванию времени
    ]
    ```
*   **Ошибки:**
    *   `400 Bad Request`: Не указан ID задачи, неверный формат ID задачи.
    *   `403 Forbidden`: Пользователь не аутентифицирован или не имеет прав на просмотр.
    *   `404 Not Found`: Задача не найдена.
    *   `500 Internal Server Error`: Ошибка сервера.
``` 