# API Документация: Таск-трекер

**Базовый URL:** `/tasks`
**Аутентификация:** Все эндпоинты требуют валидный JWT токен в заголовке `Authorization: Bearer <token>`.

---

## 1. Создание новой задачи

*   **Метод:** `POST`
*   **URL:** `/tasks`
*   **Описание:** Создает новую задачу с возможностью назначения нескольких исполнителей. ID создателя берется из токена.
*   **Тело запроса (JSON):**
    ```json
    {
      "title": "Разработать UI для задач", // Обязательное поле
      "description": "Создать компоненты для отображения списка и деталей задачи.", // Опционально
      "status": "open", // Опционально (по умолчанию 'open')
      "priority": 2, // Опционально (по умолчанию 3)
      "assignee_ids": [ // Опционально: Массив UUID пользователей-исполнителей
        "uuid-пользователя-1", 
        "uuid-пользователя-2"
      ], 
      "due_date": "2024-12-31T23:59:59Z" // Опционально (дата в формате ISO 8601)
    }
    ```
*   **Успешный ответ (201 Created):**
    ```json
    {
      "id": "uuid-созданной-задачи",
      "title": "Разработать UI для задач",
      "description": "Создать компоненты для отображения списка и деталей задачи.",
      "status": "open",
      "priority": 2,
      "creator_id": "uuid-создателя-из-токена",
      // "assignee_id" - удалено
      "due_date": "2024-12-31T23:59:59.000Z",
      "created_at": "2023-11-16T10:00:00.000Z",
      "updated_at": "2023-11-16T10:00:00.000Z",
      "assignees": [ // Массив назначенных исполнителей
        { "id": "uuid-пользователя-1", "username": "user_one" },
        { "id": "uuid-пользователя-2", "username": "user_two" }
      ] 
    }
    ```
*   **Ошибки:**
    *   `400 Bad Request`: Не указано обязательное поле `title`, `assignee_ids` не является массивом, один или несколько ID исполнителей не найдены.
    *   `403 Forbidden`: Пользователь не аутентифицирован.
    *   `500 Internal Server Error`: Ошибка на сервере при создании задачи или назначении исполнителей.

---

## 2. Получение списка задач

*   **Метод:** `GET`
*   **URL:** `/tasks`
*   **Описание:** Возвращает список задач, где текущий пользователь является создателем **или** одним из назначенных исполнителей. Поддерживает фильтрацию и поиск.
*   **Query Параметры (опционально):**
    *   `status` (string): Фильтр по статусу задачи.
    *   `search` (string): Поиск по названию (`title`) или описанию (`description`) задачи.
*   **Пример URL:** `/tasks?status=in_progress`
*   **Успешный ответ (200 OK):** Массив объектов задач.
    ```json
    [
      {
        "id": "uuid-задачи-1",
        "title": "Задача с несколькими исполнителями",
        "description": null,
        "status": "in_progress",
        "priority": 3,
        "creator_id": "uuid-пользователя-А",
        "due_date": null,
        "created_at": "2023-11-16T11:00:00.000Z",
        "updated_at": "2023-11-16T11:00:00.000Z",
        "creator_username": "usernameA",
        "assignees": [ // Массив исполнителей
           { "id": "uuid-текущего-пользователя", "username": "your_username" },
           { "id": "uuid-пользователя-Б", "username": "usernameB" }
        ]
      },
      {
        "id": "uuid-задачи-2",
        "title": "Задача без исполнителей",
        // ... другие поля ...
        "creator_id": "uuid-текущего-пользователя",
        "creator_username": "your_username",
        "assignees": [] // Пустой массив, если нет исполнителей
      }
    ]
    ```
*   **Ошибки:**
    *   `403 Forbidden`: Пользователь не аутентифицирован.
    *   `500 Internal Server Error`: Ошибка на сервере при получении списка.

---

## 3. Получение задачи по ID

*   **Метод:** `GET`
*   **URL:** `/tasks/:id` (где `:id` - UUID задачи)
*   **Описание:** Возвращает детальную информацию о конкретной задаче. Доступно создателю **или** любому из назначенных исполнителей задачи.
*   **Успешный ответ (200 OK):** Объект задачи.
    ```json
    {
      "id": "запрошенный-uuid-задачи",
      "title": "Название задачи",
      // ... остальные поля ...
      "creator_id": "uuid-создателя",
      "creator_username": "creator_username",
      "assignees": [
        { "id": "uuid-исполнителя-1", "username": "assignee_one" },
        { "id": "uuid-исполнителя-2", "username": "assignee_two" }
      ]
    }
    ```
*   **Ошибки:**
    *   `400 Bad Request`: Неверный формат `:id`.
    *   `403 Forbidden`: Пользователь не аутентифицирован или не является создателем/исполнителем.
    *   `404 Not Found`: Задача с указанным `:id` не найдена.
    *   `500 Internal Server Error`: Ошибка на сервере.

---

## 4. Обновление задачи

*   **Метод:** `PUT`
*   **URL:** `/tasks/:id` (где `:id` - UUID задачи)
*   **Описание:** Обновляет поля существующей задачи, включая список исполнителей. Доступно создателю **или** любому из *текущих* исполнителей. Записывает изменения в лог.
*   **Тело запроса (JSON):** Объект с полями, которые нужно обновить. Можно передавать только изменяемые поля. Передача `assignee_ids` полностью заменяет текущий список исполнителей.
    ```json
    {
      "title": "Обновленное название", // Опционально
      "status": "done", // Опционально
      "assignee_ids": [ // Опционально: Новый список UUID исполнителей
        "uuid-исполнителя-2", 
        "uuid-нового-исполнителя-3" 
      ] 
      // "uuid-исполнителя-1" будет удален из задачи, "uuid-нового-исполнителя-3" будет добавлен
    }
    ```
*   **Успешный ответ (200 OK):** Полный объект обновленной задачи с актуальным списком `assignees`.
    ```json
     {
      "id": "обновленный-uuid-задачи",
      "title": "Обновленное название",
      "status": "done",
       // ... остальные поля ...
      "creator_id": "uuid-создателя",
      "creator_username": "creator_username",
      "assignees": [
        { "id": "uuid-исполнителя-2", "username": "assignee_two" },
        { "id": "uuid-нового-исполнителя-3", "username": "assignee_three" }
      ]
    }
    ```
*   **Ошибки:**
    *   `400 Bad Request`: Неверный формат `:id`, нет данных для обновления, `assignee_ids` не массив, один из `assignee_ids` не найден.
    *   `403 Forbidden`: Пользователь не аутентифицирован или не является создателем/текущим исполнителем.
    *   `404 Not Found`: Задача с указанным `:id` не найдена.
    *   `500 Internal Server Error`: Ошибка на сервере при обновлении или логировании.

---

## 5. Удаление задачи

*   **Метод:** `DELETE`
*   **URL:** `/tasks/:id` (где `:id` - UUID задачи)
*   **Описание:** Удаляет задачу. Доступно **только создателю** задачи. Связанные исполнители (`task_assignees`), комментарии, вложения и логи удаляются автоматически (CASCADE).
*   **Успешный ответ (204 No Content):** Пустой ответ с кодом 204.
*   **Ошибки:**
    *   `400 Bad Request`: Неверный формат `:id`.
    *   `403 Forbidden`: Пользователь не аутентифицирован или не является создателем задачи.
    *   `404 Not Found`: Задача с указанным `:id` не найдена.
    *   `500 Internal Server Error`: Ошибка на сервере при удалении.

---

## 6. Добавление комментария к задаче

*   **Метод:** `POST`
*   **URL:** `/tasks/:id/comments` (где `:id` - UUID задачи)
*   **Описание:** Добавляет текстовый комментарий к задаче. Доступно создателю **или** любому из назначенных исполнителей задачи.
*   **Тело запроса (JSON):**
    ```json
    {
      "comment": "Комментарий к задаче." // Обязательное поле
    }
    ```
*   **Успешный ответ (201 Created):** Объект созданного комментария (структура не изменилась).
*   **Ошибки:**
    *   `400 Bad Request`: Не указан `:id` задачи, не передан `comment` или он пустой.
    *   `403 Forbidden`: Пользователь не аутентифицирован или не имеет доступа к задаче (не создатель и не исполнитель).
    *   `404 Not Found`: Задача с указанным `:id` не найдена.
    *   `500 Internal Server Error`: Ошибка на сервере.

---

## 7. Получение комментариев задачи

*   **Метод:** `GET`
*   **URL:** `/tasks/:id/comments` (где `:id` - UUID задачи)
*   **Описание:** Возвращает список всех комментариев для указанной задачи. Доступно создателю **или** любому из назначенных исполнителей задачи.
*   **Успешный ответ (200 OK):** Массив объектов комментариев (структура не изменилась).
*   **Ошибки:**
    *   `400 Bad Request`: Неверный формат `:id`.
    *   `403 Forbidden`: Пользователь не аутентифицирован или не имеет доступа к задаче (не создатель и не исполнитель).
    *   `404 Not Found`: Задача с указанным `:id` не найдена.
    *   `500 Internal Server Error`: Ошибка на сервере.

---

## 8. Добавление вложения (файла) к задаче

*   **Метод:** `POST`
*   **URL:** `/tasks/:id/attachments` (где `:id` - UUID задачи)
*   **Описание:** Загружает один файл и прикрепляет его к задаче. Использует `multipart/form-data`. Доступно создателю **или** любому из назначенных исполнителей задачи.
*   **Тело запроса (multipart/form-data):** Поле `file`.
*   **Успешный ответ (201 Created):** Объект созданного вложения (структура не изменилась).
*   **Ошибки:**
    *   `400 Bad Request`: Не указан `:id` задачи, файл не был загружен, файл слишком большой.
    *   `403 Forbidden`: Пользователь не аутентифицирован или не имеет доступа к задаче (не создатель и не исполнитель).
    *   `404 Not Found`: Задача с указанным `:id` не найдена.
    *   `500 Internal Server Error`: Ошибка на сервере.

---

## 9. Получение списка вложений задачи

*   **Метод:** `GET`
*   **URL:** `/tasks/:id/attachments` (где `:id` - UUID задачи)
*   **Описание:** Возвращает список всех файлов, прикрепленных к задаче. Доступно создателю **или** любому из назначенных исполнителей задачи.
*   **Успешный ответ (200 OK):** Массив объектов вложений (структура не изменилась). URL для скачивания: `/uploads/<file_path>`.
*   **Ошибки:**
    *   `400 Bad Request`: Неверный формат `:id`.
    *   `403 Forbidden`: Пользователь не аутентифицирован или не имеет доступа к задаче (не создатель и не исполнитель).
    *   `404 Not Found`: Задача с указанным `:id` не найдена.
    *   `500 Internal Server Error`: Ошибка на сервере.

---

## 10. Получение логов изменений задачи

*   **Метод:** `GET`
*   **URL:** `/tasks/:id/logs` (где `:id` - UUID задачи)
*   **Описание:** Возвращает историю изменений для указанной задачи. **Внимание:** Проверка прав доступа для этого эндпоинта *не была обновлена* и может работать некорректно или использовать старую логику.
*   **Успешный ответ (200 OK):** Массив объектов логов, отсортированный по убыванию времени.
    ```json
    [
      // ... другие логи ...
      {
        "id": "uuid-лога-изменения-исполнителей",
        "task_id": "uuid-задачи",
        "action": "update_assignees", // Действие для изменения исполнителей
        "old_value": "["uuid-старого-исп-1","uuid-старого-исп-2"]", // JSON-строка массива старых ID
        "new_value": "["uuid-старого-исп-2","uuid-нового-исп-3"]", // JSON-строка массива новых ID
        "changed_by": "uuid-пользователя-обновившего",
        "changed_at": "2023-11-16T12:00:00.000Z",
        "changed_by_username": "updater_username"
      }
      // ... другие логи ...
    ]
    ```
*   **Ошибки:**
    *   `400 Bad Request`: Неверный формат `:id`.
    *   `403 Forbidden`: Пользователь не аутентифицирован или (возможно) не имеет доступа к задаче по старой логике.
    *   `404 Not Found`: Задача с указанным `:id` не найдена.
    *   `500 Internal Server Error`: Ошибка на сервере.

--- 