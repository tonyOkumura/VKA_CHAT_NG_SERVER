# API Документация: Задачи (Tasks)

Этот документ описывает API эндпоинты для управления задачами, комментариями, вложениями, логами и отчетами.

**Базовый URL:** `/tasks`

**Аутентификация:** Все эндпоинты требуют валидный JWT токен в заголовке `Authorization: Bearer <token>`.

---

## 1. Задачи (Tasks)

### 1.1. Создание Задачи

*   **Метод:** `POST`
*   **Путь:** `/`
*   **Назначение:** Создает новую задачу.
*   **Тело Запроса (JSON):**
    ```json
    {
      "title": "Название задачи (обязательно)",
      "description": "Описание задачи (опционально)",
      "status": "статус (опционально, default: 'open')", 
      "priority": 1, // число (опционально, default: 3)
      "assignee_id": "UUID исполнителя (опционально, null если нет)",
      "due_date": "ISO 8601 строка даты срока (опционально, null если нет)" 
    }
    ```
*   **Успешный Ответ (201 Created):**
    *   **Тело (JSON):** Объект созданной задачи (включая `id`, `created_at`, `updated_at`, `creator_id`).
    ```json
    {
      "id": "UUID задачи",
      "title": "...",
      "description": "...",
      "status": "open",
      "priority": 3,
      "creator_id": "UUID создателя",
      "assignee_id": null,
      "due_date": null,
      "created_at": "ISO 8601 строка",
      "updated_at": "ISO 8601 строка"
      // + creator_username, assignee_username (если нужны сразу)
    }
    ```
*   **Ошибки:**
    *   `400 Bad Request`: Отсутствует `title` или другие обязательные поля.
    *   `401 Unauthorized`: Неверный или отсутствующий токен.
    *   `500 Internal Server Error`: Ошибка сервера при создании.

### 1.2. Получение Списка Задач

*   **Метод:** `GET`
*   **Путь:** `/`
*   **Назначение:** Получает список задач, доступных текущему пользователю (где он создатель или исполнитель).
*   **Query Параметры (Опционально):**
    *   `status` (String, comma-separated): Фильтр по статусам (e.g., `open,in_progress`).
    *   `search` (String): Поиск по `title` или `description` (регистронезависимый).
    *   `priority` (String, comma-separated): Фильтр по приоритетам.
    *   `assigneeId` (String): Фильтр по ID исполнителя (`me`, `null`).
    *   `creatorId` (String): Фильтр по ID создателя (`me`).
    *   `dueDateStart`, `dueDateEnd` (ISO 8601): Фильтр по сроку выполнения.
    *   `dueDateFilter` (String): `null` или `notnull`.
    *   `updatedBeforeDays` (Number): Фильтр "застрявших".
    *   *Примечание:* Этот эндпоинт можно использовать с фильтрами из отчетов, но он вернет *полные* объекты задач, а не агрегированную статистику.
*   **Успешный Ответ (200 OK):**
    *   **Тело (JSON):** Массив объектов задач.
    ```json
    [
      {
        "id": "UUID задачи",
        "title": "...",
        "description": "...",
        "status": "...",
        "priority": 1,
        "creator_id": "UUID",
        "creator_username": "...",
        "assignee_id": "UUID или null",
        "assignee_username": "... или null",
        "due_date": "ISO 8601 или null",
        "created_at": "ISO 8601",
        "updated_at": "ISO 8601"
      },
      // ... другие задачи
    ]
    ```
*   **Ошибки:**
    *   `401 Unauthorized`: Неверный токен.
    *   `500 Internal Server Error`: Ошибка сервера.

### 1.3. Получение Задачи по ID

*   **Метод:** `POST`
*   **Путь:** `/get`
*   **Назначение:** Получает одну задачу по её ID.
*   **Тело Запроса (JSON):**
    ```json
    {
      "taskId": "UUID задачи (обязательно)"
    }
    ```
*   **Успешный Ответ (200 OK):**
    *   **Тело (JSON):** Объект задачи (аналогично п. 1.2).
*   **Ошибки:**
    *   `400 Bad Request`: Не указан `taskId` в теле.
    *   `401 Unauthorized`: Неверный токен.
    *   `403 Forbidden`: Нет прав доступа к этой задаче.
    *   `404 Not Found`: Задача с таким ID не найдена.
    *   `500 Internal Server Error`: Ошибка сервера.

### 1.4. Обновление Задачи

*   **Метод:** `PUT`
*   **Путь:** `/update`
*   **Назначение:** Обновляет поля задачи.
*   **Тело Запроса (JSON):**
    ```json
    {
      "taskId": "UUID задачи (обязательно)",
      // --- Обновляемые поля (хотя бы одно) ---
      "title": "Новое название", 
      "description": "Новое описание",
      "status": "in_progress",
      "priority": 2,
      "assignee_id": "UUID нового исполнителя или null",
      "due_date": "ISO 8601 нового срока или null"
    }
    ```
*   **Успешный Ответ (200 OK):**
    *   **Тело (JSON):** Полный объект обновленной задачи (аналогично п. 1.2).
*   **Ошибки:**
    *   `400 Bad Request`: Не указан `taskId`, нет данных для обновления, неверный формат полей (например, `assignee_id`).
    *   `401 Unauthorized`: Неверный токен.
    *   `403 Forbidden`: Нет прав на обновление задачи.
    *   `404 Not Found`: Задача или указанный `assignee_id` не найдены.
    *   `500 Internal Server Error`: Ошибка сервера.

### 1.5. Удаление Задачи

*   **Метод:** `DELETE`
*   **Путь:** `/delete`
*   **Назначение:** Удаляет задачу и все связанные с ней данные (комментарии, вложения, логи).
*   **Тело Запроса (JSON):**
    ```json
    {
      "taskId": "UUID задачи (обязательно)"
    }
    ```
*   **Успешный Ответ (200 OK):**
    *   **Тело (JSON):**
      ```json
      {
          "message": "Задача и все связанные данные успешно удалены.",
          "taskId": "UUID удаленной задачи"
      }
      ```
*   **Ошибки:**
    *   `400 Bad Request`: Не указан `taskId`.
    *   `401 Unauthorized`: Неверный токен.
    *   `403 Forbidden`: Нет прав на удаление задачи (например, не создатель).
    *   `404 Not Found`: Задача не найдена.
    *   `500 Internal Server Error`: Ошибка сервера.

---

## 2. Комментарии к Задачам

### 2.1. Добавление Комментария

*   **Метод:** `POST`
*   **Путь:** `/comments/add`
*   **Назначение:** Добавляет комментарий к задаче.
*   **Тело Запроса (JSON):**
    ```json
    {
      "taskId": "UUID задачи (обязательно)",
      "comment": "Текст комментария (обязательно)"
    }
    ```
*   **Успешный Ответ (201 Created):**
    *   **Тело (JSON):** Объект созданного комментария.
    ```json
    {
      "id": "UUID комментария",
      "task_id": "UUID задачи",
      "commenter_id": "UUID комментатора",
      "commenter_username": "Имя комментатора",
      "comment": "Текст комментария",
      "created_at": "ISO 8601 строка"
    }
    ```
*   **Ошибки:**
    *   `400 Bad Request`: Не указан `taskId` или `comment`.
    *   `401 Unauthorized`: Неверный токен.
    *   `403 Forbidden`: Нет прав комментировать задачу.
    *   `404 Not Found`: Задача не найдена.
    *   `500 Internal Server Error`: Ошибка сервера.

### 2.2. Получение Комментариев

*   **Метод:** `POST`
*   **Путь:** `/comments/get`
*   **Назначение:** Получает все комментарии для указанной задачи.
*   **Тело Запроса (JSON):**
    ```json
    {
      "taskId": "UUID задачи (обязательно)"
    }
    ```
*   **Успешный Ответ (200 OK):**
    *   **Тело (JSON):** Массив объектов комментариев (см. п. 2.1), отсортированных по `created_at` (ASC).
*   **Ошибки:**
    *   `400 Bad Request`: Не указан `taskId`.
    *   `401 Unauthorized`: Неверный токен.
    *   `403 Forbidden`: Нет прав просматривать комментарии.
    *   `404 Not Found`: Задача не найдена.
    *   `500 Internal Server Error`: Ошибка сервера.

---

## 3. Вложения к Задачам

### 3.1. Добавление Вложения

*   **Метод:** `POST`
*   **Путь:** `/attachments/add`
*   **Назначение:** Загружает файл и прикрепляет его к задаче.
*   **Тип Запроса:** `multipart/form-data`
*   **Тело Запроса (Form Data):**
    *   Поле `file`: Сам загружаемый файл (обязательно).
    *   Поле `taskId`: UUID задачи (обязательно).
*   **Успешный Ответ (201 Created):**
    *   **Тело (JSON):** Объект добавленного вложения.
    ```json
    {
      "id": "UUID вложения",
      "task_id": "UUID задачи",
      "file_name": "имя файла",
      "file_type": "MIME тип",
      "file_size": 12345, // в байтах
      "upload_date": "ISO 8601 строка",
      "uploaded_by": "UUID загрузившего",
      "uploaded_by_username": "Имя загрузившего",
      "download_url": "/api/tasks/attachments/UUID вложения/download" // URL для скачивания
    }
    ```
*   **Ошибки:**
    *   `400 Bad Request`: Не передан файл (`file`) или `taskId`.
    *   `401 Unauthorized`: Неверный токен.
    *   `403 Forbidden`: Нет прав добавлять вложения.
    *   `404 Not Found`: Задача не найдена.
    *   `500 Internal Server Error`: Ошибка сервера или ошибка сохранения файла.

### 3.2. Получение Списка Вложений

*   **Метод:** `POST`
*   **Путь:** `/attachments/get`
*   **Назначение:** Получает список всех вложений для задачи.
*   **Тело Запроса (JSON):**
    ```json
    {
      "taskId": "UUID задачи (обязательно)"
    }
    ```
*   **Успешный Ответ (200 OK):**
    *   **Тело (JSON):** Массив объектов вложений (см. п. 3.1), отсортированных по `created_at` (ASC).
*   **Ошибки:**
    *   `400 Bad Request`: Не указан `taskId`.
    *   `401 Unauthorized`: Неверный токен.
    *   `403 Forbidden`: Нет прав просматривать вложения.
    *   `404 Not Found`: Задача не найдена.
    *   `500 Internal Server Error`: Ошибка сервера.

### 3.3. Скачивание Вложения

*   **Метод:** `GET`
*   **Путь:** `/attachments/:attachmentId/download`
*   **Назначение:** Скачивает файл вложения по его ID.
*   **Параметры Пути:**
    *   `:attachmentId`: UUID вложения (обязательно).
*   **Успешный Ответ (200 OK):**
    *   **Тело:** Бинарные данные файла с соответствующими заголовками (`Content-Type`, `Content-Disposition`).
*   **Ошибки:**
    *   `400 Bad Request`: Неверный формат `attachmentId`.
    *   `401 Unauthorized`: Неверный токен.
    *   `403 Forbidden`: Нет прав скачивать файл.
    *   `404 Not Found`: Вложение или файл на диске не найдены.
    *   `500 Internal Server Error`: Ошибка сервера при чтении/отправке файла.

### 3.4. Удаление Вложения

*   **Метод:** `DELETE`
*   **Путь:** `/attachments/:attachmentId/delete`
*   **Назначение:** Удаляет вложение (запись из БД и файл с диска).
*   **Параметры Пути:**
    *   `:attachmentId`: UUID вложения (обязательно).
*   **Успешный Ответ (200 OK):**
    *   **Тело (JSON):**
      ```json
      {
          "message": "Вложение успешно удалено.",
          "taskId": "UUID задачи, к которой относилось вложение",
          "attachmentId": "UUID удаленного вложения"
      }
      ```
*   **Ошибки:**
    *   `400 Bad Request`: Неверный формат `attachmentId`.
    *   `401 Unauthorized`: Неверный токен.
    *   `403 Forbidden`: Нет прав на удаление вложения.
    *   `404 Not Found`: Вложение не найдено.
    *   `500 Internal Server Error`: Ошибка сервера.

---

## 4. Логи Изменений Задач

### 4.1. Получение Логов Задачи

*   **Метод:** `POST`
*   **Путь:** `/logs/get`
*   **Назначение:** Получает историю изменений для указанной задачи.
*   **Тело Запроса (JSON):**
    ```json
    {
      "taskId": "UUID задачи (обязательно)"
    }
    ```
*   **Успешный Ответ (200 OK):**
    *   **Тело (JSON):** Массив объектов логов, отсортированных по `changed_at` (DESC - от новых к старым).
    ```json
    [
      {
        "log_id": "UUID лога", // Используется log_id вместо id
        "task_id": "UUID задачи",
        "action": "update_status", // тип действия (e.g., update_title, add_comment, ...)
        "old_value": "open",
        "new_value": "in_progress",
        "changed_by": "UUID пользователя",
        "changed_by_username": "Имя пользователя",
        "changed_at": "ISO 8601 строка"
      },
      // ... другие логи
    ]
    ```
*   **Ошибки:**
    *   `400 Bad Request`: Не указан `taskId`.
    *   `401 Unauthorized`: Неверный токен.
    *   `403 Forbidden`: Нет прав просматривать логи.
    *   `404 Not Found`: Задача не найдена.
    *   `500 Internal Server Error`: Ошибка сервера.

---

## 5. Отчеты по Задачам

### 5.1. Генерация Отчета

*   **Метод:** `GET`
*   **Путь:** `/report`
*   **Назначение:** Получает агрегированную статистику по задачам с учетом фильтров.
*   **Query Параметры (Опционально):**
    *   `startDate`, `endDate` (String, ISO 8601): Фильтр по дате создания.
    *   `status` (String, comma-separated): Фильтр по статусам.
    *   `priority` (String, comma-separated): Фильтр по приоритетам.
    *   `assigneeId` (String): Фильтр по ID исполнителя (`me`, `null`).
    *   `creatorId` (String): Фильтр по ID создателя (`me`).
    *   `dueDateStart`, `dueDateEnd` (String, ISO 8601): Фильтр по сроку выполнения.
    *   `dueDateFilter` (String): `'null'` (без срока), `'notnull'` (со сроком).
    *   `updatedBeforeDays` (Number): Фильтр "застрявших" задач.
*   **Успешный Ответ (200 OK):**
    *   **Тело (JSON):** Структурированный отчет (см. предыдущий ответ для детальной структуры JSON).
*   **Ошибки:**
    *   `400 Bad Request`: Неверный формат параметров (дат, чисел).
    *   `401 Unauthorized`: Неверный токен.
    *   `500 Internal Server Error`: Ошибка сервера при генерации отчета.

---
``` 